pipeline {
    environment {
        commit_id = ""
	    registry = "yp29/jenkinsmultibranch"
	    registryCredential = "dockerhub"
	    rep_name_dev = "development"
	    rep_name_prod = "production"
	    docker_dev_name = "docker-development-app"
	    docker_prod_name = "docker-production-app"
    }

    agent 'slave02-jnlp'

    stages {
        stage('Prepare') {
            agent 'slave01-ssh'
            steps {
		        sh "echo Preparation stage is running."
                checkout scm  
                sh "git rev-parse --short HEAD > .git/commit-id"
                commit_id = readFile('.git/commit-id').trim()
                sh "echo Preparation stage completed."   
            }
        }
		stage('Ansible Test'){
			steps{
				if(env.BRANCH_NAME == "Ansible-Deploy"){
            		sh "echo Test stage is running."
	    			//sh "ansible-playbook -i ./Inventory/hosts.ini ./ymlFiles/TestConnection.yml"
        		}
			}
		}
    	stage('Ansible Installations'){
			steps{
    	    	if(env.BRANCH_NAME == "Ansible-Deploy"){
    	    	    sh "ansible-playbook -i ./Inventory/hosts.ini ./ymlFiles/Prerequisites.yml"
    	    	}
			}
    	}
		stage('Cleanup') {
			steps{
				sh "echo Cleanup stage is running."
				sh "docker image prune -af"
				sh "echo cleanup stage completed."
			}
		}
	}
}   